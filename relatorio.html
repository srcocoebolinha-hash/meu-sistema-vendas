<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio de Vendas</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #007bff; color: white; }
        tr:hover { background-color: #f1f1f1; }
        .total { font-size: 1.2em; font-weight: bold; margin-top: 20px; color: #28a745; }
    </style>
</head>
<body>
    <h1>üìã Relat√≥rio de Vendas</h1>
    <a href="index.html">‚¨ÖÔ∏è Voltar para o Cadastro</a>
    
    <button onclick="limparTudo()" style="background: #dc3545; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; margin-left: 10px;">
        ‚ö†Ô∏è Limpar Todo o Hist√≥rico
    </button>
    
    <table id="tabelaVendas">
        <thead>
            <tr>
                <th>Data</th>
                <th>Produto</th>
                <th>Valor (R$)</th>
                <th>A√ß√£o</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div class="total" id="somaTotal">Total: R$ 0,00</div>

    <script>
        // O guarda da p√°gina
        async function verificarAcesso() {
            const senhaDigitada = prompt("Digite a senha para acessar o relat√≥rio:");
            
            // Vamos perguntar ao servidor se a senha est√° certa
            const resposta = await fetch('/verificar-senha', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ senha: senhaDigitada })
            });

            const resultado = await resposta.json();

            if (!resultado.autorizado) {
                alert("Senha incorreta! Acesso negado.");
                window.location.href = "index.html"; // Manda de volta pro in√≠cio
            } else {
                carregarVendas(); // Se estiver certo, carrega os dados
            }
        }

        async function carregarVendas() {
            const resposta = await fetch('/vendas');
            const vendas = await resposta.json();
            const corpoTabela = document.querySelector('#tabelaVendas tbody');
            let totalGeral = 0;

            corpoTabela.innerHTML = ''; // Limpa a tabela

            vendas.forEach(venda => {
                const dataFormatada = new Date(venda.data).toLocaleDateString('pt-BR');
                const linha = `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>${venda.produto}</td>
                        <td>R$ ${venda.valor.toFixed(2)}</td>
                        <td>
                            <button onclick="excluirVenda('${venda._id}')" style="color: red; border: none; background: none; cursor: pointer;">
                                üóëÔ∏è Excluir
                            </button>
                        </td>
                    </tr>
                `;
                corpoTabela.innerHTML += linha;
                totalGeral += venda.valor;
            });

            document.getElementById('somaTotal').innerText = `Total: R$ ${totalGeral.toFixed(2)}`;
        }

        async function excluirVenda(id) {
            if (confirm("Deseja realmente excluir esta venda?")) {
                await fetch(`/vendas/${id}`, { method: 'DELETE' });
                carregarVendas(); // Recarrega a lista automaticamente
            }
        }

        async function limparTudo() {
            if (confirm("CUIDADO: Isso vai apagar TODAS as suas vendas. Confirmar?")) {
                await fetch('/limpar-hist√≥rico', { method: 'DELETE' });
                carregarVendas();
            }
        }

        // Chame a verifica√ß√£o ao abrir a p√°gina
        verificarAcesso();
    </script>
</body>
</html>